> __该模块实现在`Spring Boot`项目中数据源的自动配置和加载__

---

## i. 功能
- 多数据源配置
- `Mybatis`支持
- `sharding-jdbc`支持

---

## ii. 使用

### 1. 依赖

__1.1 引入`maven`依赖__

``` xml
<dependency>
    <groupId>org.s3s3l.yggdrasil</groupId>
    <artifactId>yggdrasil-datasource-spring-boot-starter</artifactId>
</dependency>
```

---

### 2. 多数据源配置

``` yaml
yggdrasil:
  datasource:
    enable: true # 组件开关
    dbs:
      your_first_db:
        url: ${your-first-db-url}
        username: $${your-first-db-username}
        password: ${your-first-db-password}
        switch-conf: # 自动切换配置
            db: # 另一个db配置，配置项跟当前这个一样
            time: # 切换时间
        # 连接池配置
        maxIdle: 5
        minIdle: 2
        initialSize: 2
        driverClassName: driver.class.name
        jmxEnabled: false
        testWhileIdle: false
        validationQuery: SELECT 1
        testOnBorrow: true
        testOnReturn: false
        validationInterval: 30000
        timeBetweenEvictionRunsMillis: 10000
        maxWait: 60000
        removeAbandoned: true
        removeAbandonedTimeout: 60000
        minEvictableIdleTimeMillis: 60000
        logAbandoned: true
      your_second_db:
        url: ${your-second-db-url}
        username: $${your-second-db-username}
        password: ${your-second-db-password}
        switch-conf: # 自动切换配置
            db: # 另一个db配置，配置项跟当前这个一样
            time: # 切换时间
        # 连接池配置
        maxIdle: 5
        minIdle: 2
        initialSize: 2
        driverClassName: driver.class.name
        jmxEnabled: false
        testWhileIdle: false
        validationQuery: SELECT 1
        testOnBorrow: true
        testOnReturn: false
        validationInterval: 30000
        timeBetweenEvictionRunsMillis: 10000
        maxWait: 60000
        removeAbandoned: true
        removeAbandonedTimeout: 60000
        minEvictableIdleTimeMillis: 60000
        logAbandoned: true
      # some other datasource configuration
      ...
```

---

### 3. `sharding-jdbc`配置

``` yaml
yggdrasil:
  datasource:
    enable: true # 组件开关
    sharding: 
      your_first_sharding_datasource_name:
        rule: # sharding rule, see io.shardingsphere.core.yaml.sharding.YamlShardingRuleConfiguration
          ...
        config-map: # sharding config map, see https://github.com/apache/incubator-shardingsphere
        props: # sharding props, see https://github.com/apache/incubator-shardingsphere
        dbs:
          db_shard_0: # shard0 datasource config
            ...
          db_shard_1: # shard1 datasource config
            ...
        ...
```

---

### 4. `mybatis`配置

``` yaml
yggdrasil:
  datasource:
    enable: true # 组件开关
    mybatis:
      check-config-location: true # 检查配置文件是否存在，true：当配置文件不存在的时候抛出错误，false：配置文件不存在时使用默认配置
      config: file:config/mybatis/mybatis-config.xml # 配置文件路径
      mapper-locations: file:config/mybatis/mapper/**/*.xml # mapper文件路径
      type-aliases-package: your.model.package # 类型定义包名
      mapper-packages:
        ${your-db-name}: your.mapper.package # mapper接口所在包，key为任意已配置数据源的名称
```

---

### 5. 数据源实例选择配置

``` yaml
yggdrasil:
  datasource:
    enable: true # 组件开关
    required-instances: # 该配置用于限制只初始化指定的数据源，如未配置，则初始化所有已配置的数据源
    - ${your-db-name}
```

---

### 6. 在服务中使用
__6.1 该组件在启动过程中会注入如下几类`Bean`__

- `javax.sql.DataSource`
    - 普通数据源以`${your-db-name}` + `Datasource`作为`BeanName`
    - `Sharding`数据源以`${your-db-name}` + `ShardingDatasource`作为`BeanName`
    - 定时切换数据源以`${your-db-name}` + `SwitchableDatasource`作为`BeanName`
- `org.springframework.jdbc.datasource.DataSourceTransactionManager`
    - 以`${your-db-name}` + `TransactionManager`作为`BeanName`
- `org.mybatis.spring.SqlSessionFactoryBean`
    - 以`${your-db-name}` + `SqlSessionFactory`作为`BeanName`
- `org.mybatis.spring.SqlSessionTemplate`
    - 以`${your-db-name}` + `SessionTemplate`作为`BeanName`
- `Mapper`
    - 可直接以类型注入


__6.2 使用`Mapper`__

``` java
@Service
public class YourService {
    @Autowired
    private YourMapper yourMapper;
}
```

__6.3 使用`TransactionManager`__

``` java
@Service
public class YourService {
    @Transactional(transactionManager = "yourFirstDbTransactionManager")
    public void doSomethingWithDB() {

    }
}
```

---

## iii. 子模块
- `MultiDatasourceConfiguration`
    - 多数据源配置
- `MultiDatasourceAutoConfigure`
    - 多数据源自动配置